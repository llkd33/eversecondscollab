# ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ê³„ì„œ

## ğŸ—„ï¸ ê°œìš”

### 1.1 ëª©ì 
ì—ë²„ì„¸ì»¨ì¦ˆ í”Œë«í¼ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„

### 1.2 ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ
- **DBMS**: PostgreSQL 15.x (Supabase)
- **íŠ¹ì§•**: ê´€ê³„í˜•, ACID ì¤€ìˆ˜, JSON ì§€ì›, Full-text Search

### 1.3 ì„¤ê³„ ì›ì¹™
- ì •ê·œí™” (3NF ì´ìƒ)
- í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°
- ì¸ë±ìŠ¤ ìµœì í™”
- Row Level Security (RLS)
- ê°ì‚¬ ì¶”ì  (Audit Trail)

---

## ğŸ“‹ ER ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚       â”‚   products   â”‚       â”‚ categories  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)     â”‚1    âˆ â”‚ id (PK)      â”‚âˆ     1â”‚ id (PK)     â”‚
â”‚ email       â”‚â”€â”€â”€â”€â”€â”€â”€â”‚ seller_id(FK)â”‚â”€â”€â”€â”€â”€â”€â”€â”‚ name        â”‚
â”‚ name        â”‚       â”‚ category_id  â”‚       â”‚ icon        â”‚
â”‚ avatar_url  â”‚       â”‚ title        â”‚       â”‚ parent_id   â”‚
â”‚ role        â”‚       â”‚ price        â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at  â”‚       â”‚ images[]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ status       â”‚
       â”‚              â”‚ created_at   â”‚
       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚                     â”‚
       â”‚1                   âˆâ”‚
       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚ transactions â”‚
       â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚              â”‚ id (PK)      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ product_id   â”‚
                  âˆ   â”‚ buyer_id(FK) â”‚
                      â”‚ seller_id(FK)â”‚
                      â”‚ amount       â”‚
                      â”‚ status       â”‚
                      â”‚ created_at   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š í…Œì´ë¸” ì„¤ê³„

### 2.1 users (ì‚¬ìš©ì)

**ëª©ì **: í”Œë«í¼ ì‚¬ìš©ì ì •ë³´ ì €ì¥

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE users (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì¸ì¦ ì •ë³´
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  kakao_id VARCHAR(100) UNIQUE,

  -- í”„ë¡œí•„ ì •ë³´
  name VARCHAR(100) NOT NULL,
  avatar_url TEXT,
  bio TEXT,

  -- ì—­í•  ë° ê¶Œí•œ
  role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin', 'moderator')),

  -- íŒë§¤ì ì •ë³´
  seller_slug VARCHAR(100) UNIQUE,  -- ì›¹ëª° URL ìš©
  kakao_channel_url TEXT,

  -- í†µê³„
  total_products INTEGER DEFAULT 0,
  total_sales INTEGER DEFAULT 0,
  rating DECIMAL(3,2) DEFAULT 0.00,
  total_reviews INTEGER DEFAULT 0,

  -- ìƒíƒœ
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),
  suspended_until TIMESTAMP WITH TIME ZONE,
  suspended_reason TEXT,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_login_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_kakao_id ON users(kakao_id);
CREATE INDEX idx_users_seller_slug ON users(seller_slug);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role ON users(role);

-- Full-text search ì¸ë±ìŠ¤
CREATE INDEX idx_users_name_fts ON users USING gin(to_tsvector('korean', name));

-- íŠ¸ë¦¬ê±°: updated_at ìë™ ì—…ë°ì´íŠ¸
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
INSERT INTO users (email, name, kakao_id, seller_slug, role) VALUES
('gildong@kakao.com', 'í™ê¸¸ë™', 'kakao_123456', 'honggildong', 'user'),
('admin@everseconds.com', 'ê´€ë¦¬ì', NULL, NULL, 'admin');
```

---

### 2.2 categories (ì¹´í…Œê³ ë¦¬)

**ëª©ì **: ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ê³„ì¸µ êµ¬ì¡°

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE categories (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì¹´í…Œê³ ë¦¬ ì •ë³´
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  icon VARCHAR(50),  -- ì´ëª¨ì§€ ë˜ëŠ” ì•„ì´ì½˜ ì´ë¦„
  description TEXT,

  -- ê³„ì¸µ êµ¬ì¡°
  parent_id UUID REFERENCES categories(id) ON DELETE CASCADE,
  level INTEGER DEFAULT 0,  -- 0: ìµœìƒìœ„, 1: í•˜ìœ„
  order_index INTEGER DEFAULT 0,

  -- ìƒíƒœ
  is_active BOOLEAN DEFAULT true,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_categories_parent_id ON categories(parent_id);
CREATE INDEX idx_categories_slug ON categories(slug);
CREATE INDEX idx_categories_is_active ON categories(is_active);

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_categories_updated_at
  BEFORE UPDATE ON categories
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
-- ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬
INSERT INTO categories (name, slug, icon, level) VALUES
('ì˜ë¥˜/íŒ¨ì…˜', 'fashion', 'ğŸ‘”', 0),
('ì „ìê¸°ê¸°', 'electronics', 'ğŸ“±', 0),
('ë””ì§€í„¸/ê°€ì „', 'appliances', 'ğŸ’»', 0),
('ì·¨ë¯¸/ê²Œì„', 'hobby', 'ğŸ®', 0),
('ë„ì„œ/ë¬¸êµ¬', 'books', 'ğŸ“š', 0),
('ê°€êµ¬/ì¸í…Œë¦¬ì–´', 'furniture', 'ğŸ¡', 0);

-- í•˜ìœ„ ì¹´í…Œê³ ë¦¬ (ì „ìê¸°ê¸°)
INSERT INTO categories (name, slug, parent_id, level)
SELECT 'ìŠ¤ë§ˆíŠ¸í°', 'smartphone', id, 1 FROM categories WHERE slug = 'electronics';
INSERT INTO categories (name, slug, parent_id, level)
SELECT 'íƒœë¸”ë¦¿', 'tablet', id, 1 FROM categories WHERE slug = 'electronics';
INSERT INTO categories (name, slug, parent_id, level)
SELECT 'ë…¸íŠ¸ë¶', 'laptop', id, 1 FROM categories WHERE slug = 'electronics';
```

---

### 2.3 products (ìƒí’ˆ)

**ëª©ì **: íŒë§¤ ìƒí’ˆ ì •ë³´ ì €ì¥

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE products (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  seller_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES categories(id),
  subcategory_id UUID REFERENCES categories(id),

  -- ìƒí’ˆ ì •ë³´
  title VARCHAR(200) NOT NULL,
  description TEXT,

  -- ê°€ê²©
  price INTEGER NOT NULL CHECK (price >= 0),
  original_price INTEGER CHECK (original_price >= price),

  -- ìƒíƒœ
  condition VARCHAR(20) NOT NULL CHECK (condition IN ('new', 'like_new', 'good', 'fair', 'poor')),
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'pending', 'sold', 'reserved', 'hidden', 'deleted')),

  -- ì´ë¯¸ì§€ (ë°°ì—´)
  images TEXT[] DEFAULT '{}',
  thumbnail_url TEXT,

  -- ê±°ë˜ ì •ë³´
  trade_methods TEXT[] DEFAULT '{}' CHECK (trade_methods <@ ARRAY['direct', 'delivery']),
  trade_location VARCHAR(200),

  -- í†µê³„
  views INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  contacts INTEGER DEFAULT 0,

  -- QR ì½”ë“œ
  qr_code_url TEXT,

  -- ë©”íƒ€ ì •ë³´
  metadata JSONB DEFAULT '{}',

  -- Full-text search
  fts TSVECTOR,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sold_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_products_seller_id ON products(seller_id);
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_subcategory_id ON products(subcategory_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- Full-text search ì¸ë±ìŠ¤
CREATE INDEX idx_products_fts ON products USING gin(fts);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_products_category_status ON products(category_id, status);
CREATE INDEX idx_products_seller_status ON products(seller_id, status);

-- FTS ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION products_fts_update() RETURNS TRIGGER AS $$
BEGIN
  NEW.fts := to_tsvector('korean', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.description, ''));
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER products_fts_trigger
  BEFORE INSERT OR UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION products_fts_update();

-- updated_at íŠ¸ë¦¬ê±°
CREATE TRIGGER update_products_updated_at
  BEFORE UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
INSERT INTO products (
  seller_id,
  category_id,
  subcategory_id,
  title,
  description,
  price,
  original_price,
  condition,
  images,
  trade_methods,
  trade_location
)
SELECT
  (SELECT id FROM users WHERE email = 'gildong@kakao.com'),
  (SELECT id FROM categories WHERE slug = 'electronics'),
  (SELECT id FROM categories WHERE slug = 'smartphone'),
  'ì•„ì´í° 13 Pro 128GB ê·¸ë˜íŒŒì´íŠ¸',
  '2023ë…„ 9ì›” êµ¬ë§¤. ë³´í˜¸í•„ë¦„ê³¼ ì¼€ì´ìŠ¤ ì‚¬ìš©. ë°°í„°ë¦¬ ì„±ëŠ¥ 92%.',
  800000,
  1350000,
  'like_new',
  ARRAY['https://example.com/image1.jpg', 'https://example.com/image2.jpg'],
  ARRAY['direct', 'delivery'],
  'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬';
```

---

### 2.4 transactions (ê±°ë˜)

**ëª©ì **: ìƒí’ˆ ê±°ë˜ ë‚´ì—­ ì¶”ì 

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE transactions (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  product_id UUID NOT NULL REFERENCES products(id),
  seller_id UUID NOT NULL REFERENCES users(id),
  buyer_id UUID NOT NULL REFERENCES users(id),

  -- ê±°ë˜ ì •ë³´
  amount INTEGER NOT NULL,
  trade_method VARCHAR(20) CHECK (trade_method IN ('direct', 'delivery')),
  trade_location VARCHAR(200),

  -- ìƒíƒœ
  status VARCHAR(20) DEFAULT 'initiated' CHECK (
    status IN ('initiated', 'confirmed', 'completed', 'cancelled', 'disputed')
  ),

  -- ë©”ëª¨
  seller_memo TEXT,
  buyer_memo TEXT,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  confirmed_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  cancelled_at TIMESTAMP WITH TIME ZONE,

  -- ì·¨ì†Œ/ë¶„ìŸ ì‚¬ìœ 
  cancel_reason TEXT,
  dispute_reason TEXT
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_transactions_product_id ON transactions(product_id);
CREATE INDEX idx_transactions_seller_id ON transactions(seller_id);
CREATE INDEX idx_transactions_buyer_id ON transactions(buyer_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_transactions_created_at ON transactions(created_at DESC);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_transactions_seller_status ON transactions(seller_id, status);
CREATE INDEX idx_transactions_buyer_status ON transactions(buyer_id, status);
```

---

### 2.5 wishlists (ì°œí•˜ê¸°)

**ëª©ì **: ì‚¬ìš©ì ê´€ì‹¬ ìƒí’ˆ ì €ì¥

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE wishlists (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- ìœ ë‹ˆí¬ ì œì•½
  UNIQUE(user_id, product_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_wishlists_user_id ON wishlists(user_id);
CREATE INDEX idx_wishlists_product_id ON wishlists(product_id);
```

---

### 2.6 reviews (ë¦¬ë·°)

**ëª©ì **: ê±°ë˜ í›„ê¸° ë° í‰ì 

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE reviews (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  transaction_id UUID NOT NULL REFERENCES transactions(id) ON DELETE CASCADE,
  seller_id UUID NOT NULL REFERENCES users(id),
  buyer_id UUID NOT NULL REFERENCES users(id),
  product_id UUID NOT NULL REFERENCES products(id),

  -- ë¦¬ë·° ë‚´ìš©
  rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,

  -- í‰ê°€ í•­ëª©
  seller_kindness INTEGER CHECK (seller_kindness BETWEEN 1 AND 5),
  product_quality INTEGER CHECK (product_quality BETWEEN 1 AND 5),
  fast_response INTEGER CHECK (fast_response BETWEEN 1 AND 5),

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- ìœ ë‹ˆí¬ ì œì•½ (í•œ ê±°ë˜ë‹¹ í•œ ë¦¬ë·°)
  UNIQUE(transaction_id, buyer_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_reviews_seller_id ON reviews(seller_id);
CREATE INDEX idx_reviews_buyer_id ON reviews(buyer_id);
CREATE INDEX idx_reviews_product_id ON reviews(product_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);
CREATE INDEX idx_reviews_created_at ON reviews(created_at DESC);

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_reviews_updated_at
  BEFORE UPDATE ON reviews
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.7 reports (ì‹ ê³ )

**ëª©ì **: ë¶€ì ì ˆí•œ ìƒí’ˆ/ì‚¬ìš©ì ì‹ ê³ 

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE reports (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  reporter_id UUID NOT NULL REFERENCES users(id),

  -- ì‹ ê³  ëŒ€ìƒ
  target_type VARCHAR(20) NOT NULL CHECK (target_type IN ('product', 'user')),
  target_id UUID NOT NULL,

  -- ì‹ ê³  ë‚´ìš©
  reason VARCHAR(50) NOT NULL CHECK (reason IN (
    'inappropriate_content',
    'fraud',
    'spam',
    'counterfeit',
    'prohibited_item',
    'other'
  )),
  description TEXT NOT NULL,

  -- ì¦ê±° ìë£Œ
  evidence_urls TEXT[],

  -- ì²˜ë¦¬ ìƒíƒœ
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'reviewing', 'resolved', 'rejected')),

  -- ì²˜ë¦¬ ì •ë³´
  reviewed_by UUID REFERENCES users(id),
  resolution TEXT,
  resolved_at TIMESTAMP WITH TIME ZONE,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_reports_reporter_id ON reports(reporter_id);
CREATE INDEX idx_reports_target_type ON reports(target_type);
CREATE INDEX idx_reports_target_id ON reports(target_id);
CREATE INDEX idx_reports_status ON reports(status);
CREATE INDEX idx_reports_created_at ON reports(created_at DESC);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_reports_target ON reports(target_type, target_id);

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_reports_updated_at
  BEFORE UPDATE ON reports
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.8 contact_logs (ì—°ë½ ë¡œê·¸)

**ëª©ì **: íŒë§¤ì ì—°ë½ ì¶”ì 

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE contact_logs (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  product_id UUID NOT NULL REFERENCES products(id),
  buyer_id UUID NOT NULL REFERENCES users(id),
  seller_id UUID NOT NULL REFERENCES users(id),

  -- ì—°ë½ ë°©ë²•
  contact_method VARCHAR(20) DEFAULT 'kakao',

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  contacted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_contact_logs_product_id ON contact_logs(product_id);
CREATE INDEX idx_contact_logs_buyer_id ON contact_logs(buyer_id);
CREATE INDEX idx_contact_logs_seller_id ON contact_logs(seller_id);
CREATE INDEX idx_contact_logs_contacted_at ON contact_logs(contacted_at DESC);
```

---

### 2.9 admin_logs (ê´€ë¦¬ì í™œë™ ë¡œê·¸)

**ëª©ì **: ê´€ë¦¬ì í™œë™ ê°ì‚¬ ì¶”ì 

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE admin_logs (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  admin_id UUID NOT NULL REFERENCES users(id),

  -- í™œë™ ì •ë³´
  action VARCHAR(100) NOT NULL,
  target_type VARCHAR(50),
  target_id UUID,

  -- ìƒì„¸ ì •ë³´
  details JSONB,

  -- ìš”ì²­ ì •ë³´
  ip_address INET,
  user_agent TEXT,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_admin_logs_admin_id ON admin_logs(admin_id);
CREATE INDEX idx_admin_logs_action ON admin_logs(action);
CREATE INDEX idx_admin_logs_target ON admin_logs(target_type, target_id);
CREATE INDEX idx_admin_logs_created_at ON admin_logs(created_at DESC);
```

---

### 2.10 notifications (ì•Œë¦¼)

**ëª©ì **: ì‚¬ìš©ì ì•Œë¦¼

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE notifications (
  -- ê¸°ë³¸ í‚¤
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì™¸ë˜ í‚¤
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- ì•Œë¦¼ ë‚´ìš©
  type VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  message TEXT NOT NULL,

  -- ë§í¬
  link_url TEXT,

  -- ìƒíƒœ
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMP WITH TIME ZONE,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = false;
```

---

## ğŸ” Row Level Security (RLS)

### 3.1 ì‚¬ìš©ì í…Œì´ë¸” RLS

```sql
-- ëª¨ë“  ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì •ë³´ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view own profile"
ON users FOR SELECT
TO authenticated
USING (auth.uid() = id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¡œí•„ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own profile"
ON users FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- ê³µê°œ í”„ë¡œí•„ì€ ëª¨ë‘ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can view public profiles"
ON users FOR SELECT
TO authenticated
USING (true);
```

### 3.2 ìƒí’ˆ í…Œì´ë¸” RLS

```sql
-- ëª¨ë“  ì‚¬ìš©ìëŠ” í™œì„± ìƒí’ˆ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can view active products"
ON products FOR SELECT
TO authenticated
USING (status = 'active');

-- íŒë§¤ìëŠ” ìì‹ ì˜ ìƒí’ˆ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Sellers can view own products"
ON products FOR SELECT
TO authenticated
USING (seller_id = auth.uid());

-- íŒë§¤ìëŠ” ìì‹ ì˜ ìƒí’ˆ ë“±ë¡ ê°€ëŠ¥
CREATE POLICY "Users can insert own products"
ON products FOR INSERT
TO authenticated
WITH CHECK (seller_id = auth.uid());

-- íŒë§¤ìëŠ” ìì‹ ì˜ ìƒí’ˆ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Sellers can update own products"
ON products FOR UPDATE
TO authenticated
USING (seller_id = auth.uid())
WITH CHECK (seller_id = auth.uid());

-- íŒë§¤ìëŠ” ìì‹ ì˜ ìƒí’ˆ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Sellers can delete own products"
ON products FOR DELETE
TO authenticated
USING (seller_id = auth.uid());
```

### 3.3 ê´€ë¦¬ì ì „ìš© RLS

```sql
-- ê´€ë¦¬ìëŠ” ëª¨ë“  ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥
CREATE POLICY "Admins have full access"
ON products FOR ALL
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role IN ('admin', 'moderator')
  )
);
```

---

## ğŸ”§ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

### 4.1 updated_at ìë™ ì—…ë°ì´íŠ¸

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 4.2 ì¡°íšŒìˆ˜ ì¦ê°€

```sql
CREATE OR REPLACE FUNCTION increment_views(product_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE products
  SET views = views + 1
  WHERE id = product_id;
END;
$$ LANGUAGE plpgsql;
```

### 4.3 ì‚¬ìš©ì í†µê³„ ì—…ë°ì´íŠ¸

```sql
CREATE OR REPLACE FUNCTION update_user_stats(user_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE users
  SET
    total_products = (
      SELECT COUNT(*) FROM products WHERE seller_id = user_id AND status != 'deleted'
    ),
    total_sales = (
      SELECT COUNT(*) FROM transactions WHERE seller_id = user_id AND status = 'completed'
    ),
    rating = (
      SELECT AVG(rating) FROM reviews WHERE seller_id = user_id
    ),
    total_reviews = (
      SELECT COUNT(*) FROM reviews WHERE seller_id = user_id
    )
  WHERE id = user_id;
END;
$$ LANGUAGE plpgsql;
```

### 4.4 ëŒ€ì‹œë³´ë“œ KPI ì¡°íšŒ

```sql
CREATE OR REPLACE FUNCTION get_dashboard_kpis(start_date DATE, end_date DATE)
RETURNS TABLE(
  new_products INTEGER,
  new_users INTEGER,
  new_transactions INTEGER,
  total_views INTEGER,
  new_reports INTEGER,
  active_users INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    (SELECT COUNT(*)::INTEGER FROM products WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM users WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM transactions WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT SUM(views)::INTEGER FROM products WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM reports WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(DISTINCT seller_id)::INTEGER FROM products WHERE updated_at::DATE BETWEEN start_date AND end_date);
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“ˆ ì¸ë±ìŠ¤ ì „ëµ

### 5.1 ì£¼ìš” ì¸ë±ìŠ¤

**ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”**:
```sql
-- ìƒí’ˆ ê²€ìƒ‰ (ê°€ì¥ ë¹ˆë²ˆ)
CREATE INDEX idx_products_category_status ON products(category_id, status);
CREATE INDEX idx_products_price ON products(price);

-- íŒë§¤ì ìƒí’ˆ ì¡°íšŒ
CREATE INDEX idx_products_seller_status ON products(seller_id, status);

-- ìµœì‹  ìƒí’ˆ ì •ë ¬
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- Full-text search
CREATE INDEX idx_products_fts ON products USING gin(fts);
```

### 5.2 ì»¤ë²„ë§ ì¸ë±ìŠ¤

```sql
-- ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ ìµœì í™”
CREATE INDEX idx_products_list_covering
ON products(category_id, status, created_at DESC)
INCLUDE (id, title, price, thumbnail_url, seller_id);
```

---

## ğŸ”„ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

### 6.1 ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

```sql
-- 1. í…Œì´ë¸” ìƒì„± ìˆœì„œ (ì™¸ë˜ í‚¤ ì˜ì¡´ì„±)
-- users â†’ categories â†’ products â†’ transactions â†’ reviews â†’ etc.

-- 2. ê¸°ë³¸ ë°ì´í„° ì‚½ì…
-- ì¹´í…Œê³ ë¦¬, ê´€ë¦¬ì ê³„ì •

-- 3. ì¸ë±ìŠ¤ ìƒì„±

-- 4. RLS ì •ì±… ì ìš©

-- 5. í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±° ìƒì„±
```

### 6.2 ë²„ì „ ê´€ë¦¬

```sql
CREATE TABLE schema_migrations (
  version VARCHAR(20) PRIMARY KEY,
  description TEXT,
  applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

INSERT INTO schema_migrations (version, description) VALUES
('1.0.0', 'Initial schema'),
('1.1.0', 'Add notifications table'),
('1.2.0', 'Add full-text search');
```

---

## ğŸ§ª ë°ì´í„° ê²€ì¦

### 7.1 ì œì•½ ì¡°ê±´

```sql
-- ê°€ê²© ê²€ì¦
ALTER TABLE products ADD CONSTRAINT check_price_positive CHECK (price >= 0);
ALTER TABLE products ADD CONSTRAINT check_original_price CHECK (original_price >= price);

-- í‰ì  ë²”ìœ„
ALTER TABLE reviews ADD CONSTRAINT check_rating_range CHECK (rating BETWEEN 1 AND 5);

-- ìƒíƒœ ê°’
ALTER TABLE products ADD CONSTRAINT check_product_status CHECK (
  status IN ('active', 'pending', 'sold', 'reserved', 'hidden', 'deleted')
);
```

---

## ğŸ“Š ì„±ëŠ¥ ìµœì í™”

### 8.1 íŒŒí‹°ì…”ë‹

```sql
-- ë¡œê·¸ í…Œì´ë¸” ì›”ë³„ íŒŒí‹°ì…”ë‹
CREATE TABLE admin_logs_2025_10 PARTITION OF admin_logs
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

CREATE TABLE admin_logs_2025_11 PARTITION OF admin_logs
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

### 8.2 VACUUM ë° ANALYZE

```sql
-- ì •ê¸°ì ì¸ VACUUM ì„¤ì •
ALTER TABLE products SET (autovacuum_vacuum_scale_factor = 0.05);
ALTER TABLE products SET (autovacuum_analyze_scale_factor = 0.02);

-- ìˆ˜ë™ ì‹¤í–‰
VACUUM ANALYZE products;
```

---

## ğŸ”’ ë°±ì—… ë° ë³µêµ¬

### 9.1 ë°±ì—… ì „ëµ

```bash
# ì „ì²´ ë°±ì—… (ì¼ì¼)
pg_dump -h localhost -U postgres -d everseconds > backup_$(date +%Y%m%d).sql

# í…Œì´ë¸”ë³„ ë°±ì—…
pg_dump -h localhost -U postgres -d everseconds -t products > products_backup.sql
```

### 9.2 ë³µêµ¬

```bash
# ì „ì²´ ë³µêµ¬
psql -h localhost -U postgres -d everseconds < backup_20251030.sql

# íŠ¹ì • í…Œì´ë¸” ë³µêµ¬
psql -h localhost -U postgres -d everseconds < products_backup.sql
```

---

## ğŸ“ ë°ì´í„° ëª¨ë¸ í™•ì¥

### 10.1 í–¥í›„ ì¶”ê°€ ì˜ˆì • í…Œì´ë¸”

```sql
-- ì±„íŒ… ë©”ì‹œì§€
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID NOT NULL REFERENCES users(id),
  recipient_id UUID NOT NULL REFERENCES users(id),
  product_id UUID REFERENCES products(id),
  content TEXT NOT NULL,
  is_read BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ê²°ì œ ì •ë³´ (ì¶”í›„ ê²°ì œ ì‹œìŠ¤í…œ ë„ì… ì‹œ)
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  transaction_id UUID NOT NULL REFERENCES transactions(id),
  amount INTEGER NOT NULL,
  method VARCHAR(50),
  status VARCHAR(20),
  payment_key VARCHAR(200),
  paid_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

### 11.1 ê´€ë ¨ ë¦¬ì†ŒìŠ¤
- PostgreSQL ê³µì‹ ë¬¸ì„œ: https://www.postgresql.org/docs/
- Supabase ê³µì‹ ë¬¸ì„œ: https://supabase.com/docs
- Database Normalization: https://en.wikipedia.org/wiki/Database_normalization

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-30
**ì‘ì„±ì**: ì—ë²„ì„¸ì»¨ì¦ˆ ê°œë°œíŒ€
**ê´€ë ¨ ë¬¸ì„œ**: [í”„ë¡œì íŠ¸ ê°œìš”](./í”„ë¡œì íŠ¸_ê°œìš”.md)
