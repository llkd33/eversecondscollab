# 데이터베이스 구조 설계서

## 🗄️ 개요

### 1.1 목적
에버세컨즈 플랫폼의 모든 데이터를 효율적으로 저장하고 관리하기 위한 데이터베이스 스키마 설계

### 1.2 데이터베이스 시스템
- **DBMS**: PostgreSQL 15.x (Supabase)
- **특징**: 관계형, ACID 준수, JSON 지원, Full-text Search

### 1.3 설계 원칙
- 정규화 (3NF 이상)
- 확장 가능한 구조
- 인덱스 최적화
- Row Level Security (RLS)
- 감사 추적 (Audit Trail)

---

## 📋 ER 다이어그램

```
┌─────────────┐       ┌──────────────┐       ┌─────────────┐
│   users     │       │   products   │       │ categories  │
├─────────────┤       ├──────────────┤       ├─────────────┤
│ id (PK)     │1    ∞ │ id (PK)      │∞     1│ id (PK)     │
│ email       │───────│ seller_id(FK)│───────│ name        │
│ name        │       │ category_id  │       │ icon        │
│ avatar_url  │       │ title        │       │ parent_id   │
│ role        │       │ price        │       └─────────────┘
│ created_at  │       │ images[]     │
└─────────────┘       │ status       │
       │              │ created_at   │
       │              └──────────────┘
       │                     │
       │                     │
       │1                   ∞│
       │              ┌──────────────┐
       │              │ transactions │
       │              ├──────────────┤
       │              │ id (PK)      │
       └──────────────│ product_id   │
                  ∞   │ buyer_id(FK) │
                      │ seller_id(FK)│
                      │ amount       │
                      │ status       │
                      │ created_at   │
                      └──────────────┘
```

---

## 📊 테이블 설계

### 2.1 users (사용자)

**목적**: 플랫폼 사용자 정보 저장

**스키마**:
```sql
CREATE TABLE users (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 인증 정보
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  kakao_id VARCHAR(100) UNIQUE,

  -- 프로필 정보
  name VARCHAR(100) NOT NULL,
  avatar_url TEXT,
  bio TEXT,

  -- 역할 및 권한
  role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin', 'moderator')),

  -- 판매자 정보
  seller_slug VARCHAR(100) UNIQUE,  -- 웹몰 URL 용
  kakao_channel_url TEXT,

  -- 통계
  total_products INTEGER DEFAULT 0,
  total_sales INTEGER DEFAULT 0,
  rating DECIMAL(3,2) DEFAULT 0.00,
  total_reviews INTEGER DEFAULT 0,

  -- 상태
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),
  suspended_until TIMESTAMP WITH TIME ZONE,
  suspended_reason TEXT,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_login_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- 인덱스
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_kakao_id ON users(kakao_id);
CREATE INDEX idx_users_seller_slug ON users(seller_slug);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role ON users(role);

-- Full-text search 인덱스
CREATE INDEX idx_users_name_fts ON users USING gin(to_tsvector('korean', name));

-- 트리거: updated_at 자동 업데이트
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**샘플 데이터**:
```sql
INSERT INTO users (email, name, kakao_id, seller_slug, role) VALUES
('gildong@kakao.com', '홍길동', 'kakao_123456', 'honggildong', 'user'),
('admin@everseconds.com', '관리자', NULL, NULL, 'admin');
```

---

### 2.2 categories (카테고리)

**목적**: 상품 카테고리 계층 구조

**스키마**:
```sql
CREATE TABLE categories (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 카테고리 정보
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  icon VARCHAR(50),  -- 이모지 또는 아이콘 이름
  description TEXT,

  -- 계층 구조
  parent_id UUID REFERENCES categories(id) ON DELETE CASCADE,
  level INTEGER DEFAULT 0,  -- 0: 최상위, 1: 하위
  order_index INTEGER DEFAULT 0,

  -- 상태
  is_active BOOLEAN DEFAULT true,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_categories_parent_id ON categories(parent_id);
CREATE INDEX idx_categories_slug ON categories(slug);
CREATE INDEX idx_categories_is_active ON categories(is_active);

-- 트리거
CREATE TRIGGER update_categories_updated_at
  BEFORE UPDATE ON categories
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**샘플 데이터**:
```sql
-- 최상위 카테고리
INSERT INTO categories (name, slug, icon, level) VALUES
('의류/패션', 'fashion', '👔', 0),
('전자기기', 'electronics', '📱', 0),
('디지털/가전', 'appliances', '💻', 0),
('취미/게임', 'hobby', '🎮', 0),
('도서/문구', 'books', '📚', 0),
('가구/인테리어', 'furniture', '🏡', 0);

-- 하위 카테고리 (전자기기)
INSERT INTO categories (name, slug, parent_id, level)
SELECT '스마트폰', 'smartphone', id, 1 FROM categories WHERE slug = 'electronics';
INSERT INTO categories (name, slug, parent_id, level)
SELECT '태블릿', 'tablet', id, 1 FROM categories WHERE slug = 'electronics';
INSERT INTO categories (name, slug, parent_id, level)
SELECT '노트북', 'laptop', id, 1 FROM categories WHERE slug = 'electronics';
```

---

### 2.3 products (상품)

**목적**: 판매 상품 정보 저장

**스키마**:
```sql
CREATE TABLE products (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  seller_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES categories(id),
  subcategory_id UUID REFERENCES categories(id),

  -- 상품 정보
  title VARCHAR(200) NOT NULL,
  description TEXT,

  -- 가격
  price INTEGER NOT NULL CHECK (price >= 0),
  original_price INTEGER CHECK (original_price >= price),

  -- 상태
  condition VARCHAR(20) NOT NULL CHECK (condition IN ('new', 'like_new', 'good', 'fair', 'poor')),
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'pending', 'sold', 'reserved', 'hidden', 'deleted')),

  -- 이미지 (배열)
  images TEXT[] DEFAULT '{}',
  thumbnail_url TEXT,

  -- 거래 정보
  trade_methods TEXT[] DEFAULT '{}' CHECK (trade_methods <@ ARRAY['direct', 'delivery']),
  trade_location VARCHAR(200),

  -- 통계
  views INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  contacts INTEGER DEFAULT 0,

  -- QR 코드
  qr_code_url TEXT,

  -- 메타 정보
  metadata JSONB DEFAULT '{}',

  -- Full-text search
  fts TSVECTOR,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sold_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- 인덱스
CREATE INDEX idx_products_seller_id ON products(seller_id);
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_subcategory_id ON products(subcategory_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- Full-text search 인덱스
CREATE INDEX idx_products_fts ON products USING gin(fts);

-- 복합 인덱스
CREATE INDEX idx_products_category_status ON products(category_id, status);
CREATE INDEX idx_products_seller_status ON products(seller_id, status);

-- FTS 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION products_fts_update() RETURNS TRIGGER AS $$
BEGIN
  NEW.fts := to_tsvector('korean', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.description, ''));
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER products_fts_trigger
  BEFORE INSERT OR UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION products_fts_update();

-- updated_at 트리거
CREATE TRIGGER update_products_updated_at
  BEFORE UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

**샘플 데이터**:
```sql
INSERT INTO products (
  seller_id,
  category_id,
  subcategory_id,
  title,
  description,
  price,
  original_price,
  condition,
  images,
  trade_methods,
  trade_location
)
SELECT
  (SELECT id FROM users WHERE email = 'gildong@kakao.com'),
  (SELECT id FROM categories WHERE slug = 'electronics'),
  (SELECT id FROM categories WHERE slug = 'smartphone'),
  '아이폰 13 Pro 128GB 그래파이트',
  '2023년 9월 구매. 보호필름과 케이스 사용. 배터리 성능 92%.',
  800000,
  1350000,
  'like_new',
  ARRAY['https://example.com/image1.jpg', 'https://example.com/image2.jpg'],
  ARRAY['direct', 'delivery'],
  '서울시 강남구';
```

---

### 2.4 transactions (거래)

**목적**: 상품 거래 내역 추적

**스키마**:
```sql
CREATE TABLE transactions (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  product_id UUID NOT NULL REFERENCES products(id),
  seller_id UUID NOT NULL REFERENCES users(id),
  buyer_id UUID NOT NULL REFERENCES users(id),

  -- 거래 정보
  amount INTEGER NOT NULL,
  trade_method VARCHAR(20) CHECK (trade_method IN ('direct', 'delivery')),
  trade_location VARCHAR(200),

  -- 상태
  status VARCHAR(20) DEFAULT 'initiated' CHECK (
    status IN ('initiated', 'confirmed', 'completed', 'cancelled', 'disputed')
  ),

  -- 메모
  seller_memo TEXT,
  buyer_memo TEXT,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  confirmed_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  cancelled_at TIMESTAMP WITH TIME ZONE,

  -- 취소/분쟁 사유
  cancel_reason TEXT,
  dispute_reason TEXT
);

-- 인덱스
CREATE INDEX idx_transactions_product_id ON transactions(product_id);
CREATE INDEX idx_transactions_seller_id ON transactions(seller_id);
CREATE INDEX idx_transactions_buyer_id ON transactions(buyer_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_transactions_created_at ON transactions(created_at DESC);

-- 복합 인덱스
CREATE INDEX idx_transactions_seller_status ON transactions(seller_id, status);
CREATE INDEX idx_transactions_buyer_status ON transactions(buyer_id, status);
```

---

### 2.5 wishlists (찜하기)

**목적**: 사용자 관심 상품 저장

**스키마**:
```sql
CREATE TABLE wishlists (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- 유니크 제약
  UNIQUE(user_id, product_id)
);

-- 인덱스
CREATE INDEX idx_wishlists_user_id ON wishlists(user_id);
CREATE INDEX idx_wishlists_product_id ON wishlists(product_id);
```

---

### 2.6 reviews (리뷰)

**목적**: 거래 후기 및 평점

**스키마**:
```sql
CREATE TABLE reviews (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  transaction_id UUID NOT NULL REFERENCES transactions(id) ON DELETE CASCADE,
  seller_id UUID NOT NULL REFERENCES users(id),
  buyer_id UUID NOT NULL REFERENCES users(id),
  product_id UUID NOT NULL REFERENCES products(id),

  -- 리뷰 내용
  rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,

  -- 평가 항목
  seller_kindness INTEGER CHECK (seller_kindness BETWEEN 1 AND 5),
  product_quality INTEGER CHECK (product_quality BETWEEN 1 AND 5),
  fast_response INTEGER CHECK (fast_response BETWEEN 1 AND 5),

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- 유니크 제약 (한 거래당 한 리뷰)
  UNIQUE(transaction_id, buyer_id)
);

-- 인덱스
CREATE INDEX idx_reviews_seller_id ON reviews(seller_id);
CREATE INDEX idx_reviews_buyer_id ON reviews(buyer_id);
CREATE INDEX idx_reviews_product_id ON reviews(product_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);
CREATE INDEX idx_reviews_created_at ON reviews(created_at DESC);

-- 트리거
CREATE TRIGGER update_reviews_updated_at
  BEFORE UPDATE ON reviews
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.7 reports (신고)

**목적**: 부적절한 상품/사용자 신고

**스키마**:
```sql
CREATE TABLE reports (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  reporter_id UUID NOT NULL REFERENCES users(id),

  -- 신고 대상
  target_type VARCHAR(20) NOT NULL CHECK (target_type IN ('product', 'user')),
  target_id UUID NOT NULL,

  -- 신고 내용
  reason VARCHAR(50) NOT NULL CHECK (reason IN (
    'inappropriate_content',
    'fraud',
    'spam',
    'counterfeit',
    'prohibited_item',
    'other'
  )),
  description TEXT NOT NULL,

  -- 증거 자료
  evidence_urls TEXT[],

  -- 처리 상태
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'reviewing', 'resolved', 'rejected')),

  -- 처리 정보
  reviewed_by UUID REFERENCES users(id),
  resolution TEXT,
  resolved_at TIMESTAMP WITH TIME ZONE,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_reports_reporter_id ON reports(reporter_id);
CREATE INDEX idx_reports_target_type ON reports(target_type);
CREATE INDEX idx_reports_target_id ON reports(target_id);
CREATE INDEX idx_reports_status ON reports(status);
CREATE INDEX idx_reports_created_at ON reports(created_at DESC);

-- 복합 인덱스
CREATE INDEX idx_reports_target ON reports(target_type, target_id);

-- 트리거
CREATE TRIGGER update_reports_updated_at
  BEFORE UPDATE ON reports
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

### 2.8 contact_logs (연락 로그)

**목적**: 판매자 연락 추적

**스키마**:
```sql
CREATE TABLE contact_logs (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  product_id UUID NOT NULL REFERENCES products(id),
  buyer_id UUID NOT NULL REFERENCES users(id),
  seller_id UUID NOT NULL REFERENCES users(id),

  -- 연락 방법
  contact_method VARCHAR(20) DEFAULT 'kakao',

  -- 타임스탬프
  contacted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_contact_logs_product_id ON contact_logs(product_id);
CREATE INDEX idx_contact_logs_buyer_id ON contact_logs(buyer_id);
CREATE INDEX idx_contact_logs_seller_id ON contact_logs(seller_id);
CREATE INDEX idx_contact_logs_contacted_at ON contact_logs(contacted_at DESC);
```

---

### 2.9 admin_logs (관리자 활동 로그)

**목적**: 관리자 활동 감사 추적

**스키마**:
```sql
CREATE TABLE admin_logs (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  admin_id UUID NOT NULL REFERENCES users(id),

  -- 활동 정보
  action VARCHAR(100) NOT NULL,
  target_type VARCHAR(50),
  target_id UUID,

  -- 상세 정보
  details JSONB,

  -- 요청 정보
  ip_address INET,
  user_agent TEXT,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_admin_logs_admin_id ON admin_logs(admin_id);
CREATE INDEX idx_admin_logs_action ON admin_logs(action);
CREATE INDEX idx_admin_logs_target ON admin_logs(target_type, target_id);
CREATE INDEX idx_admin_logs_created_at ON admin_logs(created_at DESC);
```

---

### 2.10 notifications (알림)

**목적**: 사용자 알림

**스키마**:
```sql
CREATE TABLE notifications (
  -- 기본 키
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 외래 키
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- 알림 내용
  type VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  message TEXT NOT NULL,

  -- 링크
  link_url TEXT,

  -- 상태
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMP WITH TIME ZONE,

  -- 타임스탬프
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);

-- 복합 인덱스
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = false;
```

---

## 🔐 Row Level Security (RLS)

### 3.1 사용자 테이블 RLS

```sql
-- 모든 사용자는 자신의 정보만 조회 가능
CREATE POLICY "Users can view own profile"
ON users FOR SELECT
TO authenticated
USING (auth.uid() = id);

-- 사용자는 자신의 프로필만 수정 가능
CREATE POLICY "Users can update own profile"
ON users FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- 공개 프로필은 모두 조회 가능
CREATE POLICY "Anyone can view public profiles"
ON users FOR SELECT
TO authenticated
USING (true);
```

### 3.2 상품 테이블 RLS

```sql
-- 모든 사용자는 활성 상품 조회 가능
CREATE POLICY "Anyone can view active products"
ON products FOR SELECT
TO authenticated
USING (status = 'active');

-- 판매자는 자신의 상품 조회 가능
CREATE POLICY "Sellers can view own products"
ON products FOR SELECT
TO authenticated
USING (seller_id = auth.uid());

-- 판매자는 자신의 상품 등록 가능
CREATE POLICY "Users can insert own products"
ON products FOR INSERT
TO authenticated
WITH CHECK (seller_id = auth.uid());

-- 판매자는 자신의 상품 수정 가능
CREATE POLICY "Sellers can update own products"
ON products FOR UPDATE
TO authenticated
USING (seller_id = auth.uid())
WITH CHECK (seller_id = auth.uid());

-- 판매자는 자신의 상품 삭제 가능
CREATE POLICY "Sellers can delete own products"
ON products FOR DELETE
TO authenticated
USING (seller_id = auth.uid());
```

### 3.3 관리자 전용 RLS

```sql
-- 관리자는 모든 데이터 접근 가능
CREATE POLICY "Admins have full access"
ON products FOR ALL
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role IN ('admin', 'moderator')
  )
);
```

---

## 🔧 유틸리티 함수

### 4.1 updated_at 자동 업데이트

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 4.2 조회수 증가

```sql
CREATE OR REPLACE FUNCTION increment_views(product_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE products
  SET views = views + 1
  WHERE id = product_id;
END;
$$ LANGUAGE plpgsql;
```

### 4.3 사용자 통계 업데이트

```sql
CREATE OR REPLACE FUNCTION update_user_stats(user_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE users
  SET
    total_products = (
      SELECT COUNT(*) FROM products WHERE seller_id = user_id AND status != 'deleted'
    ),
    total_sales = (
      SELECT COUNT(*) FROM transactions WHERE seller_id = user_id AND status = 'completed'
    ),
    rating = (
      SELECT AVG(rating) FROM reviews WHERE seller_id = user_id
    ),
    total_reviews = (
      SELECT COUNT(*) FROM reviews WHERE seller_id = user_id
    )
  WHERE id = user_id;
END;
$$ LANGUAGE plpgsql;
```

### 4.4 대시보드 KPI 조회

```sql
CREATE OR REPLACE FUNCTION get_dashboard_kpis(start_date DATE, end_date DATE)
RETURNS TABLE(
  new_products INTEGER,
  new_users INTEGER,
  new_transactions INTEGER,
  total_views INTEGER,
  new_reports INTEGER,
  active_users INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    (SELECT COUNT(*)::INTEGER FROM products WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM users WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM transactions WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT SUM(views)::INTEGER FROM products WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(*)::INTEGER FROM reports WHERE created_at::DATE BETWEEN start_date AND end_date),
    (SELECT COUNT(DISTINCT seller_id)::INTEGER FROM products WHERE updated_at::DATE BETWEEN start_date AND end_date);
END;
$$ LANGUAGE plpgsql;
```

---

## 📈 인덱스 전략

### 5.1 주요 인덱스

**조회 성능 최적화**:
```sql
-- 상품 검색 (가장 빈번)
CREATE INDEX idx_products_category_status ON products(category_id, status);
CREATE INDEX idx_products_price ON products(price);

-- 판매자 상품 조회
CREATE INDEX idx_products_seller_status ON products(seller_id, status);

-- 최신 상품 정렬
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- Full-text search
CREATE INDEX idx_products_fts ON products USING gin(fts);
```

### 5.2 커버링 인덱스

```sql
-- 상품 목록 페이지 최적화
CREATE INDEX idx_products_list_covering
ON products(category_id, status, created_at DESC)
INCLUDE (id, title, price, thumbnail_url, seller_id);
```

---

## 🔄 데이터 마이그레이션

### 6.1 초기 마이그레이션 스크립트

```sql
-- 1. 테이블 생성 순서 (외래 키 의존성)
-- users → categories → products → transactions → reviews → etc.

-- 2. 기본 데이터 삽입
-- 카테고리, 관리자 계정

-- 3. 인덱스 생성

-- 4. RLS 정책 적용

-- 5. 함수 및 트리거 생성
```

### 6.2 버전 관리

```sql
CREATE TABLE schema_migrations (
  version VARCHAR(20) PRIMARY KEY,
  description TEXT,
  applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

INSERT INTO schema_migrations (version, description) VALUES
('1.0.0', 'Initial schema'),
('1.1.0', 'Add notifications table'),
('1.2.0', 'Add full-text search');
```

---

## 🧪 데이터 검증

### 7.1 제약 조건

```sql
-- 가격 검증
ALTER TABLE products ADD CONSTRAINT check_price_positive CHECK (price >= 0);
ALTER TABLE products ADD CONSTRAINT check_original_price CHECK (original_price >= price);

-- 평점 범위
ALTER TABLE reviews ADD CONSTRAINT check_rating_range CHECK (rating BETWEEN 1 AND 5);

-- 상태 값
ALTER TABLE products ADD CONSTRAINT check_product_status CHECK (
  status IN ('active', 'pending', 'sold', 'reserved', 'hidden', 'deleted')
);
```

---

## 📊 성능 최적화

### 8.1 파티셔닝

```sql
-- 로그 테이블 월별 파티셔닝
CREATE TABLE admin_logs_2025_10 PARTITION OF admin_logs
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

CREATE TABLE admin_logs_2025_11 PARTITION OF admin_logs
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

### 8.2 VACUUM 및 ANALYZE

```sql
-- 정기적인 VACUUM 설정
ALTER TABLE products SET (autovacuum_vacuum_scale_factor = 0.05);
ALTER TABLE products SET (autovacuum_analyze_scale_factor = 0.02);

-- 수동 실행
VACUUM ANALYZE products;
```

---

## 🔒 백업 및 복구

### 9.1 백업 전략

```bash
# 전체 백업 (일일)
pg_dump -h localhost -U postgres -d everseconds > backup_$(date +%Y%m%d).sql

# 테이블별 백업
pg_dump -h localhost -U postgres -d everseconds -t products > products_backup.sql
```

### 9.2 복구

```bash
# 전체 복구
psql -h localhost -U postgres -d everseconds < backup_20251030.sql

# 특정 테이블 복구
psql -h localhost -U postgres -d everseconds < products_backup.sql
```

---

## 📐 데이터 모델 확장

### 10.1 향후 추가 예정 테이블

```sql
-- 채팅 메시지
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID NOT NULL REFERENCES users(id),
  recipient_id UUID NOT NULL REFERENCES users(id),
  product_id UUID REFERENCES products(id),
  content TEXT NOT NULL,
  is_read BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 결제 정보 (추후 결제 시스템 도입 시)
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  transaction_id UUID NOT NULL REFERENCES transactions(id),
  amount INTEGER NOT NULL,
  method VARCHAR(50),
  status VARCHAR(20),
  payment_key VARCHAR(200),
  paid_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 📚 참고 문서

### 11.1 관련 리소스
- PostgreSQL 공식 문서: https://www.postgresql.org/docs/
- Supabase 공식 문서: https://supabase.com/docs
- Database Normalization: https://en.wikipedia.org/wiki/Database_normalization

---

**문서 버전**: 1.0
**최종 수정일**: 2025-10-30
**작성자**: 에버세컨즈 개발팀
**관련 문서**: [프로젝트 개요](./프로젝트_개요.md)
